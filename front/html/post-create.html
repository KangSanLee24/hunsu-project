<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸€ì“°ê¸°</title>
    <link
      rel="stylesheet"
      href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
    />
    <link rel="stylesheet" href="/static/styles/style.css" />
    <link rel="stylesheet" href="/static/styles/post-create.css" />
  </head>
  <body>
    <header>
      <div id="logo" class="logo">
        <div
          id="logo-home"
          class="logo-home"
          onClick="window.location.href='./index'"
        >
          5ZIRAP
        </div>
        <div
          id="admin-btn"
          class="admin-btn"
          onClick="window.location.href='./log-manager'"
        >
          ADMIN
        </div>
      </div>
      <nav>
        <ul>
          <li><a href="./log-in">ë¡œê·¸ì¸</a></li>
          <li><a href="./sign-up">íšŒì›ê°€ì…</a></li>
          <li><a id="userNickname"></a></li>
        </ul>
      </nav>
    </header>

    <main>
      <h1>ê²Œì‹œê¸€ ì‘ì„±</h1>
      <input type="text" id="post-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." />
      <!-- ì œëª© ì…ë ¥ -->
      <select id="post-category">
        <option value="FASHION">FASHION</option>
        <option value="CHAT">CHAT</option>
      </select>

      <!-- í•´ì‹œíƒœê·¸ ì…ë ¥ë€ ì¶”ê°€ -->
      <input
        type="text"
        id="post-hashtags"
        placeholder="í•´ì‹œíƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. #í•´ì‹œíƒœê·¸ #5ZIRAP"
      />
      <!-- í•´ì‹œíƒœê·¸ ì…ë ¥ -->

      <div class="editor-text-box" id="editor"></div>
      <!-- ì—ë””í„°ê°€ ë Œë”ë§ë  DIV -->
      <button id="post-submit">ê²Œì‹œê¸€ ì‘ì„±</button>
      <!-- ê²Œì‹œê¸€ ì œì¶œ ë²„íŠ¼ -->
    </main>

    <footer>
      <div class="footer-menu">
        <button onclick="window.location.href='./chat-list'">
          ğŸ’¬ Live Chat
        </button>
        <button onclick="window.location.href='./post-list'">ğŸ“ ê²Œì‹œíŒ</button>
        <button onclick="window.location.href='./index'">ğŸ  í™ˆìœ¼ë¡œ</button>
        <button class="footerAlarm" onclick="window.location.href='./alarm'">
          ğŸ”” ì•ŒëŒ
        </button>
        <button onclick="window.location.href='./my-page'">
          ğŸ† ë§ˆì´í˜ì´ì§€
        </button>
      </div>
    </footer>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script type="module" src="/static/js/common/header.js"></script>
    <script type="module" src="/static/js/post/post-create.js"></script>
    <script>
      // ì „ì—­ë³€ìˆ˜ë¡œ ì´ë¯¸ì§€ URL ë°°ì—´ ì„ ì–¸
      window.imageUrls = []; // ì „ì—­ë³€ìˆ˜ë¡œ ì„¤ì •

      // URLì—ì„œ ê²Œì‹œê¸€ IDë¥¼ ê°€ì ¸ì™€ì„œ ìƒì„¸ ë‚´ìš© ë¡œë“œ
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get('id');

      //postIdê°€ ì¡´ì¬í•˜ê³  ìˆ«ìì´ë©´ í•´ë‹¹ ìˆ«ìë¡œ ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
      async function fetchPost(postId) {
        try {
          const response = await fetch(`/api/posts/${postId}`);
          if (!response.ok)
            throw new Error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          return await response.json();
        } catch (error) {
          console.error(error);
        }
      }

      // ê²Œì‹œê¸€ ìˆ˜ì • ì‹œ ì œëª©, ì¹´í…Œê³ ë¦¬, ë‚´ìš©ì„ ì±„ì›Œë„£ê¸°
      async function loadPost() {
        if (postId) {
          const postData = await fetchPost(postId);
          if (postData) {
            document.getElementById('post-title').value = postData.data.title;
            document.getElementById('post-category').value =
              postData.data.category;
            editor.setMarkdown(postData.data.content); // ì—ë””í„°ì— ë‚´ìš© ì„¸íŒ…
          }
        }
      }

      loadPost();

      const editor = new toastui.Editor({
        el: document.querySelector('#editor'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
        height: 'auto', // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
        initialEditType: 'markdown', // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
        initialValue: '', // ë‚´ìš©ì˜ ì´ˆê¸° ê°’ìœ¼ë¡œ, ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ìì—´ í˜•íƒœì—¬ì•¼ í•¨
        previewStyle: 'vertical', // ë§ˆí¬ë‹¤ìš´ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ (tab || vertical)
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.',
        hooks: {
          async addImageBlobHook(blob, callback) {
            try {
              const formData = new FormData();
              formData.append('files', blob);
              const response = await fetch(`/api/posts/images`, {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('accessToken')}`,
                },
                body: formData,
              });

              const result = await response.json();
              // URLì„ ë°°ì—´ì— ì¶”ê°€
              window.imageUrls.push(result.data[0]); // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL ì €ì¥
              callback(result.data[0], 'image alt attribute');
            } catch (error) {
              console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
            }
          },
        },
      });
    </script>
  </body>
</html>
