# 트러블 슈팅
## 📝 목차

1. Redis 중복 저장
2. 게시글 생성 관련 API 변경
3. 포인트 제도 관련 트러블 슈팅
4. Redis 모듈을 병렬적으로 개발하다 생긴 문제

## 1. Redis 중복 저장

### 문제
- Redis에 저장 시, redis-json 라이브러리를 사용했을 때 `원본 데이터`와 `원본 데이터_t`라는 중복 데이터가 저장되는 현상 발견
- 원본 데이터에 설정한 TTL(Time To Live) 값을 불러 오지 못하는 상황 발생

### 해결 방법
- 기존
  - redis-json 라이브러리를 사용해 redis `json` 자료구조 사용

- 변경
  - redis `string` 자료구조로 변경

### 결과
 - redis `string` 자료구조를 사용함에 따라 value 값이 정상적으로 저장되고, TTL(Time To Live) 또한 정상적으로 설정됨을 확인

 ---

## 2. 게시글 생성 관련 API 변경

### 문제
  - 프론트 개발 중 Toast UI Editor를 추가하면서 이미지 첨부시 base64로 인코딩되어 길게 나오는 문제 발생

### 해결 방법
  - 이미지를 첨부하고 바로 aws s3에 업로드 하여 url을 전달받아 미리보기를 띄우는 형식으로 변경

### 결과
  - base64 인코딩 되어 나오는 문제 해결


---

## 3. 포인트 제도 관련 트러블 슈팅

### 문제
- 유저 피드백 결과 `일일퀘스트` 점수에 `음수` 값이 나오며 갱신이 안된다는 피드백 확인
<img src="docs/point-trouble.png" width="80%">

### 해결 방법

- 기존 로직
  1. 게시글/댓글 작성, 게시글/댓글 좋아요 생성 이벤트마다 횟수 +1 및 포인트 가산
  2. 게시글/댓글 삭제, 게시글/댓글 좋아요 삭제 이벤트마다 횟수 -1 및 포인트 감산

- 변경 로직 1
  1. 횟수 또는 포인트에 음수가 표기될 시, 강제로 0에 고정시켜 버리는 로직 추가
  
  - 결과 : 화면에서는 음수가 나오면 0으로 잘 표시되지만, 백엔드 로직에서는 횟수 마이너스 및 포인트 마이너스가 진행되고 Redis, DB에 저장되어 글 생성 3번, 삭제 3번이면 포인트 가산은 횟수 2번까지만 적용되지만 삭제는 3번 모두 적용되어 Redis, DB에서는 마이너스로 저장됨
  결국 데이터 간의 일관성을 보장할 수 없음

- 변경 로직 2
  1. 감산 로직과 가산 로직의 모든 경우의 수를 고려하여 설계하기엔 복잡성, 시간 소요가 많다고 판단하여 감산 로직을 -0 으로 결정

### 결과
  - 일일퀘스트 포인트 결과가 정상적으로 나오는 것으로 확인

---

## 4. Redis 모듈을 병렬적으로 개발하다 생긴 문제

### 문제

- Redis 클라우드 서버를 `2대`로 늘려야 하는 상황
- 아래와 같은 구조로 설계했을 때, 각각 클라이언트에 연결 과정에서 클라이언트를 둘 다 못 찾는 문제가 발생

```tree
src/
├── redis/
│ ├── redis.module.ts
│ ├── redis.service.ts
│── subredis/
│ ├── subredis.module.ts
│ ├── subredis.service.ts
```

### 해결방법

- redis 모듈 1개, 서비스 2개의 구조로 변경

```tree
src/
├── redis/
│   ├── redis.module.ts
│   ├── redis.service.ts
│   └── sub.redis.services.ts
```

### 결과

- 두 개의 클라이언트에 모두 정상적으로 연결 됨을 확인
